# Project 4: SM3的软件实现与优化 

## 项目简介

本项目围绕中国国家密码标准SM3，完成了：

- SM3哈希函数的完整软件实现与性能优化
- SM3长度扩展攻击（Length-Extension Attack）的验证实验
- 基于SM3的高效大规模Merkle树构建
- Merkle树叶子节点的存在性证明与不存在性证明设计及实现

项目兼具理论与工程实现，适用于国产密码环境下的数据完整性验证与可信证明场景，如区块链、分布式存储等。

---

## 背景与研究意义

SM3是中国密码管理局发布的密码杂凑函数标准，输出256位固定长度摘要，具有良好的安全性和国产密码体系兼容性。

Merkle树作为数据完整性和归属性证明的基础结构，广泛应用于区块链、文件系统、去中心化存储等领域。

本项目通过高效实现SM3，结合Merkle树，探索如何在国产密码环境中实现大规模、高效的数据认证机制。

---

## 主要工作内容

### 1. SM3算法实现与优化

- **算法实现**  
  根据国标GB/T 32905-2016实现SM3，包括消息填充、消息扩展、压缩函数及哈希计算流程。  
- **性能优化**  
  利用位运算宏定义、循环展开和中间变量复用等技术，优化软件执行效率。  
- **代码结构**  
  提供完整接口，包括初始化、数据更新和哈希完成，支持流式哈希计算。

### 2. 长度扩展攻击验证

- **攻击原理**  
  由于SM3基于Merkle-Damgård结构，存在长度扩展攻击风险，即攻击者可通过已知消息及摘要构造新消息的有效哈希。  
- **实验设计**  
  实现长度扩展攻击模拟，验证理论漏洞，增强对SM3安全特性的理解。

### 3. Merkle树构建与证明设计

- **树构造**  
  利用SM3哈希数据构建完全二叉Merkle树，支持动态叶子数量（如10万个叶子）。  
- **存在性证明**  
  设计生成并验证从叶子到根路径上的兄弟节点哈希，支持快速校验数据归属。  
- **不存在性证明**  
  对排序Merkle树，通过前驱和后继叶子节点的存在性证明，实现对非树内元素的否定证明。  

---

## 算法理论与公式推导

### SM3算法关键数学运算

- **消息填充**：填充`1`位及零位，最后64位表示消息长度（bit）。  
- **消息扩展**：

`
W_j = \begin{cases}
M_j, & 0 \leq j \leq 15 \\
P_1(W_{j-16} \oplus W_{j-9} \oplus (W_{j-3} \lll 15)) \oplus (W_{j-13} \lll 7) \oplus W_{j-6}, & 16 \leq j \leq 67
\end{cases}
`

- **压缩函数**（迭代64轮）：

`
\begin{cases}
SS1 = ((A \lll 12) + E + (T_j \lll j)) \lll 7 \\
SS2 = SS1 \oplus (A \lll 12) \\
TT1 = FF_j(A,B,C) + D + SS2 + W_j' \\
TT2 = GG_j(E,F,G) + H + SS1 + W_j \\
D = C, \quad C = B \lll 9, \quad B = A, \quad A = TT1 \\
H = G, \quad G = F \lll 19, \quad F = E, \quad E = P_0(TT2)
\end{cases}
`

其中函数定义见代码中的宏定义。

### Merkle树构造及证明

- **节点计算**：

`
H_{\text{parent}} = \text{SM3}(H_{\text{left}} \| H_{\text{right}})
`

- **存在性证明**：

包含证明路径：

`
\{H_{\text{sibling}_0}, H_{\text{sibling}_1}, \ldots, H_{\text{sibling}_{d-1}}\}, d \approx \lceil \log_2 n \rceil
`

- **不存在性证明**：

通过排序叶子哈希二分查找前驱、后继：

`
H_{\text{predecessor}} < H_{\text{target}} < H_{\text{successor}}
`

并验证二者存在性。

---

## 代码实现要点

### SM3模块

- 充分利用位运算优化性能，保证移植兼容性。  
- 提供完整接口支持分块数据处理。  
- 压缩函数参考标准实现，保证准确性。

### Merkle树模块

- 采用数组表示完全二叉树，节省空间，方便索引计算。  
- 支持叶子节点数量非2的幂，自动补全叶子节点。  
- 存在性与不存在性证明均实现对应接口。  
- 不存在性证明采用排序叶子哈希和二分查找设计。

### 测试

- 构造10万个叶子节点的树，测试根哈希输出。  
- 对指定叶子节点生成存在性证明，验证成功。  
- 对不存在叶子生成不存在性证明，验证成功。

---

## 运行效果展示

![image](https://github.com/sdu-wza/Innovation-and-Entrepreneurship-Practice/blob/main/Project4/image/merkle.png)
